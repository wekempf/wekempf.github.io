
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Digital Tapestry - Clojure Validation - Part IV</title>
        <meta name="description" content="Weaving a Digital Tapestry" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Digital Tapestry" href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Digital Tapestry" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Digital Tapestry" />
        <meta name="msapplication-tooltip" content="Digital Tapestry" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Digital Tapestry - Clojure Validation - Part IV" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://digitaltapestry.net/posts/clojure-validation-part-4" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
        <script src="/assets/js/background-check.min.js"></script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->
        
        <link href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css" rel="stylesheet" type="text/css">
<link href="/assets/css/atelier-sulphurpool-light.css" rel="stylesheet" />
<link href="/assets/css/overrides.css" rel="stylesheet" />

        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Digital Tapestry</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/resume">Resume</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/banner_web.jpg&quot;)">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Clojure Validation - Part IV</h1>
    <div class="meta">        
Published on Wednesday, August 22, 2018<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/Clojure" class="btn btn-default btn-xs">Clojure</a>
                    <a role="button" href="/tags/ClojureScript" class="btn btn-default btn-xs">ClojureScript</a>
                    <a role="button" href="/tags/Reagent" class="btn btn-default btn-xs">Reagent</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<h1 id="clojure-validation-part-iv">Clojure Validation - Part IV</h1>
<h3 id="i18n">I18N</h3>
<blockquote class="blockquote">
<p>I confess that I have been blind as a mole, but it is better to learn wisdom late than never to learn it at all.</p>
<footer>Sherlock Holmes</footer>
</blockquote>
<p>Last time we created really nice validation messages to display for the various input errors we detect. Over my many years as a UI developer I've learned that no matter what the product owners say today, sooner or later they will demand you localize the application. So this time we're going to get a bonus post and learn how we can localize these messages to various languages.</p>
<ul>
<li><a href="/posts/clojure-validation-part-1">Part I - Clojure Spec</a></li>
<li><a href="/posts/clojure-validation-part-2">Part II - UI Validation</a></li>
<li><a href="/posts/clojure-validation-part-3">Part III - Better Messages with Phrase</a></li>
<li>Part IV - I18N (this post)</li>
</ul>
<h2 id="final-result">Final Result</h2>
<p>Like last time, here's an embedded example of what we'll accomplish this time around.</p>
<div id="app"><p>Enable JavaScript to see the example.</p>
</div>
<div class="alert alert-info"><p>OK, we still have some aesthetic issues, but once again this is purely an example. That's my excuse and I'm sticking to it.</p>
</div>
<h2 id="what-the-heck-is-i18n">What the Heck is I18N?</h2>
<p>I18N is an abbreviation for &ldquo;internationalization&rdquo;. It's a clever abbreviation at that. &quot;Internationalization&quot; is I followed by 18 other letters followed by N. No, I cannot (will not) take credit for that, it really is the abbreviation used by the industry.</p>
<p>Internationalization is the design and development of a product, application or document content that enables easy localization for target audiences that vary in culture, region, or language. A related topic is L10N (&ldquo;localization&rdquo;&hellip; you can guess how the abbreviation came to be now): the adaptation of a product, application or document content to meet the language, cultural and other requirements of a specific target market (a locale). Technically we're going to do both in this post, but the focus is on internationalization not localization as we're only going to localize to two locales, en-US and de-DE, and even then we're going to do a lousy job of it by using Google Translate.</p>
<h2 id="tempura">Tempura</h2>
<p>We'll internationalize our &ldquo;application&rdquo; using <a href="https://github.com/ptaoussanis/tempura">Tempura</a>, which makes this very easy (especially in comparison to other programming languages in which I've done localization).</p>
<p>We'll start by adding Tempura as a dependency in <code>project.clj</code>.</p>
<pre><code class="language-Clojure">  :dependencies [[org.clojure/clojure &quot;1.9.0&quot;]
                 [ring-server &quot;0.5.0&quot;]
                 [reagent &quot;0.8.1&quot;]
                 [reagent-utils &quot;0.3.1&quot;]
                 [ring &quot;1.6.3&quot;]
                 [ring/ring-defaults &quot;0.3.1&quot;]
                 [compojure &quot;1.6.1&quot;]
                 [hiccup &quot;1.0.5&quot;]
                 [yogthos/config &quot;1.1.1&quot;]
                 [org.clojure/clojurescript &quot;1.10.339&quot;
                  :scope &quot;provided&quot;]
                 [secretary &quot;1.2.3&quot;]
                 [venantius/accountant &quot;0.2.4&quot;
                  :exclusions [org.clojure/tools.reader]]
                 [phrase &quot;0.3-alpha4&quot;]
                 [com.taoensso/tempura &quot;1.2.1&quot;]]
</code></pre>
<div class="alert alert-warning"><p>Don't forget to restart Figwheel as project changes aren't auto applied the same way that source changes are.</p>
</div>
<p>Next we'll create a <code>src/cljc/validation_experiment/i18n.cljc</code> file with the following contents.</p>
<pre><code class="language-Clojure">(ns validation-experiment.i18n
  #?(:clj  (:require [taoensso.tempura :as tempura]))
  #?(:cljs (:require [taoensso.tempura :as tempura]
                     [reagent.core :as reagent :refer [atom]])))

(defonce lang (atom :en))

(def ^:private translations
  {:en
   {:missing &quot;en missing text&quot;}})

(defn tr [resource-ids]
  (tempura/tr {:dict translations} [&#64;lang :en] resource-ids))
</code></pre>
<p>We've used <a href="https://clojure.org/guides/reader_conditionals">Reader Conditionals</a> to require differnt namespaces depending on whether we're compiling for Clojure or ClojureScript. Technically we only need ClojureScript for this series, so we could have created a <code>cljs</code> file instead of a <code>cljc</code> file, but we're showing how we could support both client and server side here. If we were compiling with Clojure the <code>atom</code> used to define <code>lang</code> would be a <code>clojure.core/atom</code>, but in ClojureScript it will be a <code>reagent.core/atom</code>.</p>
<p>Tempura's documentation recommends using a <code>partial</code> to simplify the call to <code>tr</code>, the function that gives us our translated messages. However, we want to control the language used through that <code>lang</code> atom we defined and using <code>partial</code> would create a closure that would not recognize changes to it. So, instead we declare our own <code>tr</code> that doesn't create a closure and passes the dictionary and language to <code>taoensso.tempura/tr</code>.</p>
<p>This is all we need to start localizing our &ldquo;application&rdquo;.</p>
<h2 id="internationalizing-the-ui">Internationalizing the UI</h2>
<p>This is really simple. First, we'll add our i18n namespace to the namespace declaration in <code>core.cljs</code>.</p>
<pre><code class="language-Clojure">(ns validation-experiment.core
  (:require [reagent.core :as reagent :refer [atom]]
            [validation-experiment.ssn :as ssn]
            [clojure.spec.alpha :as s]
            [phrase.alpha :refer [phrase-first defphraser]]
            [validation-experiment.i18n :refer [tr]]))
</code></pre>
<p>With that in place we can internationalize the one and only string we have (the label text).</p>
<pre><code class="language-Clojure">(defn example []
  [:div [:label (tr [&quot;Enter SSN: &quot;]) [:input {:type :text :value &#64;ssn :on-change #(reset! ssn (-&gt; % .-target .-value))}]]
   [:p {:style {:color &quot;red&quot;}} (phrase-first {} :validation-experiment.ssn/ssn &#64;ssn)]])
</code></pre>
<p>OK, not so exciting as all we've done is internationalized and not localized the label. Let's see how we could localize it. First, you'll need to add a translation in <code>i18n.cljc</code>.</p>
<pre><code class="language-Clojure">(def ^:private translations
  {:en
   {:missing &quot;en missing text&quot;
    :ui {:ssn-label &quot;Please enter an SSN: &quot;}}})
</code></pre>
<div class="alert alert-info"><p>While still English, we've used slightly different wording here so that the change to the UI is observable.</p>
</div>
<p>Now, we also have to tell <code>tr</code> which translation key to use, so modify <code>core.cljs</code> like this.</p>
<pre><code class="language-Clojure">(defn example []
  [:div [:label (tr [:ui/ssn-label &quot;Enter SSN: &quot;]) [:input {:type :text :value &#64;ssn :on-change #(reset! ssn (-&gt; % .-target .-value))}]]
   [:p {:style {:color &quot;red&quot;}} (phrase-first {} :validation-experiment.ssn/ssn &#64;ssn)]])
</code></pre>
<p>We've left in the untranslated text which demonstrates how easy it is to localize without concern for whether or not translations exist yet. However, we added the key <code>:ui/ssn-label</code> which tells tempura how to find the translation in our dictionary. With this in place you should notice the change to the UI.</p>
<p>Let's do the same sort of changes for the validation messages. You can do them piece meal just like we did the UI, but we'll just show the final changes here. First, here's the changes to <code>i18n.cljc</code>.</p>
<pre><code class="language-Clojure">(def ^:private translations
  {:en
   {:missing &quot;en missing text&quot;
    :ui {:ssn-label &quot;Please enter an SSN: &quot;}
    :ssn {:invalid-format &quot;Not a valid SSN format.&quot;
          :invalid-area &quot;\&quot;%1\&quot; is not a valid area segment.&quot;
          :invalid-group &quot;\&quot;%1\&quot; is not a valid group segment.&quot;
          :invalid-serial-number &quot;\&quot;%1\&quot; is not a valid serial number.&quot;}}})

(defn tr
    ([resource-ids] (tr resource-ids nil))
    ([resource-ids resource-args] (tempura/tr {:dict translations} [&#64;lang :en] resource-ids resource-args)))
</code></pre>
<p>We've modified our <code>tr</code> to also accept <code>resource-args</code> so we can format messages with arguments. We've also added several new resource messages to our dictionary. Note that we use sub-dictionaries to isolate messages along the same sort of lines that we isolate our functions with namespaces. So all of the <code>validation-experiment.ssn</code> related messages are in a <code>:ssn</code> sub-dictionary.</p>
<p>Resource messages we want to format, such as <code>:invalid-area</code> above are declared with numbered replacement symbols such as <code>%1</code>.</p>
<p>Here's the changes to <code>ssn.cljc</code>.</p>
<pre><code class="language-Clojure">(defphraser valid-format?
  [_ _]
  (tr [:ssn/invalid-format &quot;Not a valid SSN format.&quot;]))

(defphraser valid-area?
  [_ {:keys [val]}]
  (tr [:ssn/invalid-area &quot;\&quot;%1\&quot; is not a valid area segment.&quot;] [(subs val 0 3)]))

(defphraser valid-group?
  [_ {:keys [val]}]
  (tr [:ssn/invalid-group &quot;\&quot;%1\&quot; is not a valid group segment.&quot;] [(subs (digits val) 3 5)]))

(defphraser valid-serial-number?
  [_ {:keys [val]}]
  (tr [:ssn/invalid-serial-number &quot;\&quot;%1\&quot; is not a valid serial number.&quot;] [(subs (digits val) 5 9)]))
</code></pre>
<h2 id="localizing-to-german">Localizing to German</h2>
<p>Let's add another language translation. Here's the changes to <code>i18n.cljc</code>.</p>
<div class="alert alert-info"><p>These translations were made using Google Translate, just so you know whom to blame if you speak German and find the translation to be horrible.</p>
</div>
<pre><code class="language-Clojure">(def ^:private translations
  {:en
   {:missing &quot;en missing text&quot;
    :ui {:ssn-label &quot;Please enter an SSN: &quot;}
    :ssn {:invalid-format &quot;Not a valid SSN format.&quot;
          :invalid-area &quot;\&quot;%1\&quot; is not a valid area segment.&quot;
          :invalid-group &quot;\&quot;%1\&quot; is not a valid group segment.&quot;
          :invalid-serial-number &quot;\&quot;%1\&quot; is not a valid serial number.&quot;}}
   :de-DE
   {:missing &quot;de-DE missing text&quot;
    :ui {:ssn-label &quot;Bitte geben Sie eine SSN ein: &quot;}
    :ssn {:invalid-format &quot;Kein gültiges SSN-Format.&quot;
          :invalid-area &quot;\&quot;%1\&quot; ist kein gültiges Flächensegment.&quot;
          :invalid-group &quot;\&quot;%1\&quot; ist kein gültiges Gruppensegment.&quot;
          :invalid-serial-number &quot;\&quot;%1\&quot; ist keine gültige Seriennummer.&quot;}}})
</code></pre>
<p>With this in place you can view the translation by switching the <code>lang</code> from <code>:en</code> to <code>:de-DE</code> and back.</p>
<div class="alert alert-info"><p>Due to our use of <code>defonce</code> changing the value of <code>lang</code> in the source won't cause Figwheel to automatically update the UI so you'll have to refresh the page to see changes</p>
</div>
<p>Let's make a change to the UI to allow the user to change the language. First, we need to update the namespace in <code>core.cljs</code>.</p>
<pre><code class="language-Clojure">(ns validation-experiment.core
  (:require [reagent.core :as reagent :refer [atom]]
            [validation-experiment.ssn :as ssn]
            [clojure.spec.alpha :as s]
            [phrase.alpha :refer [phrase-first defphraser]]
            [validation-experiment.i18n :refer [tr lang]]))
</code></pre>
<p>Then we need to modify the code for our component</p>
<pre><code class="language-Clojure">(defn- swap-lang [cur-lang]
  (if (= cur-lang :en)
    :de-DE
    :en))

(defn example []
  [:div [:label (tr [:ui/ssn-label &quot;Enter SSN: &quot;]) [:input {:type :text :value &#64;ssn :on-change #(reset! ssn (-&gt; % .-target .-value))}]]
   [:p {:style {:color &quot;red&quot;}} (phrase-first {} :validation-experiment.ssn/ssn &#64;ssn)]
   [:p [:input {:type :button :value (if (= &#64;lang :en) &quot;German&quot; &quot;English&quot;) :on-click #(swap! lang swap-lang)}]]])
</code></pre>
<p>That's it! There's our complete example.</p>
<div class="alert alert-success"><p>The code for this part of the series can be found in the branch <code>part4</code> in the associated repo at <a href="https://github.com/wekempf/validation-experiment.">https://github.com/wekempf/validation-experiment.</a></p>
</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'digitaltapestry'; // required: replace example with your forum shortname
    var disqus_identifier = 'clojure-validation-part-4';
    var disqus_title = 'Clojure Validation - Part IV';
    var disqus_url = 'https://digitaltapestry.net/posts/clojure-validation-part-4';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-inline text-center">
                <li>
                    <a href="https://twitter.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
            </ul>
            <p class="copyright text-muted">
                Copyright © 2018 by William E. Kempf. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way.
                <br />
                This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                <br />
                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                <br />
                <a href="https://github.com/wekempf/wekempf.github.io"><i class="fa fa-github"></i> This Site on GitHub</a>
                <br />
                Hosted on <a href="https://pages.github.com/">GitHub Pages</a>
                <br />
                <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
            </p>
        </div>
    </div>
</div>
                </footer> 

                <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.16/clipboard.min.js"></script>
<script type="text/javascript">
    anchors.options.placement = 'left';
    anchors.add('#content > h1,h2,h3,h4');

    var snippets = document.querySelectorAll("pre > code");
    [].forEach.call(snippets, function(snippet) {
        snippet.insertAdjacentHTML("beforebegin", "<button class='btn-copy' data-clipboard-snippet><img class='clippy' width=13 src='/assets/images/clippy.svg' alt='Copy to clipboard'></button>");
    });
    var clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
        target: function(trigger) {
            return trigger.nextElementSibling;
        }
    });
    clipboardSnippets.on('success', function(e) {
        e.clearSelection();
        showTooltip(e.trigger, "Copied!");
    });
    clipboardSnippets.on('error', function(e) {
        showTooltip(e.trigger, fallbackMessage(e.action));
    });

    var btns = document.querySelectorAll('.btn-copy');
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener('mouseleave', function(e) {
            e.currentTarget.setAttribute('class', 'btn-copy');
            e.currentTarget.removeAttribute('aria-label');
        });
    }

    function showTooltip(elem, msg) {
        elem.setAttribute('class', 'btn-copy tooltipped tooltipped-s');
        elem.setAttribute('aria-label', msg);
    }

    function fallbackMessage(action) {
        var actionMsg = '';
        var actionKey = (action === 'cut' ? 'X' : 'C');
        if (/iPhone|iPad/i.test(navigator.userAgent)) {
            actionMsg = 'No support :(';
        } else if (/Mac/i.test(navigator.userAgent)) {
            actionMsg = 'Press ⌘-' + actionKey + ' to ' + action;
        } else {
            actionMsg = 'Press Ctrl-' + actionKey + ' to ' + action;
        }
        return actionMsg;
    }
    hljs.initHighlightingOnLoad();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70929529-2', 'auto');
  ga('send', 'pageview');
</script>
<script type="text/javascript" src="/assets/scripts/clojure-validation-part-4/app.js"></script>

                <script>hljs.initHighlightingOnLoad();</script>


                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>


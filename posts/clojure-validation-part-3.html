
<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Digital Tapestry - Clojure Validation - Part III</title>
        <meta name="description" content="Weaving a Digital Tapestry" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Digital Tapestry" href="/feed.rss" />
                <link type="application/atom+xml" rel="alternate" title="Digital Tapestry" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />


        <meta name="application-name" content="Digital Tapestry" />
        <meta name="msapplication-tooltip" content="Digital Tapestry" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Digital Tapestry - Clojure Validation - Part III" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="https://digitaltapestry.net/posts/clojure-validation-part-3" />
        <!-- TODO: More social graph meta tags -->

        <link href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css" rel="stylesheet" type="text/css">
<link href="/assets/css/atelier-sulphurpool-light.css" rel="stylesheet" />
<link href="/assets/css/overrides.css" rel="stylesheet" />

        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Digital Tapestry</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/posts">Archive</a></li>
        <li><a href="/tags">Tags</a></li>
        <li><a href="/resume">Resume</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/banner_web.jpg&quot;)">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Clojure Validation - Part III</h1>
    <div class="meta">        
Published on Wednesday, August 22, 2018<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/Clojure" class="btn btn-default btn-xs">Clojure</a>
                    <a role="button" href="/tags/ClojureScript" class="btn btn-default btn-xs">ClojureScript</a>
                    <a role="button" href="/tags/Reagent" class="btn btn-default btn-xs">Reagent</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<h1 id="clojure-validation-part-iii">Clojure Validation - Part III</h1>
<h3 id="better-messages-with-phrase">Better Messages with Phrase</h3>
<blockquote class="blockquote">
<p>Data! Data! Data!” he cried impatiently. “I can’t make bricks without clay.</p>
<footer>Sherlock Holmes</footer>
</blockquote>
<p>Last time we added validation to our web UI, but the validation &ldquo;messages&rdquo; were something only a Clojurist would understand or care for. This time around we're going to fix that.</p>
<p>Full series:</p>
<ul>
<li><a href="/posts/clojure-validation-part-1">Part I - Clojure Spec</a></li>
<li><a href="/posts/clojure-validation-part-2">Part II - UI Validation</a></li>
<li>Part III - Better Messages with Phrase (this post)</li>
<li><a href="/posts/clojure-validation-part-4">Part IV - I18N</a></li>
</ul>
<h2 id="final-result">Final Result</h2>
<p>Like last time, here's an embedded example of what we'll accomplish this time around.</p>
<div id="app"><p>Enable JavaScript to see the example.</p>
</div>
<div class="alert alert-info"><p>This time our behavior is much better, but I make no excuses for the appearance, other than to say that this is only sample code and not something meant for a production website.</p>
</div>
<h2 id="humane-messages">Humane Messages</h2>
<p>Last time we built a UI that displayed validation errors using <code>s/explain_data</code>. That function returns data, not a message, and that data is meant for a Clojure developer, not a normal human. So, while it was great we could easily validate input, no one would argue that what we had last time was usable in any sort of way.</p>
<p>The nice thing about Clojure Spec and the data returned by <code>s/explain_data</code> though is that it gives us very rich data that we can use programmatically any way we choose to. One thing we could do is map that data, in particular which predicate failed, to a friendly message. That's precisely what <a href="https://github.com/alexanderkiel/phrase">Phrase</a> does!</p>
<p>Let's do the simplest thing we can do to replace <code>s/explain_data</code> with <code>phrase/phrase-first</code>. First thing, you have to add <code>[phrase &quot;0.3-alpha4&quot;]</code> as a dependency to <code>project.clj</code>.</p>
<pre><code class="language-Clojure">  :dependencies [[org.clojure/clojure &quot;1.9.0&quot;]
                 [ring-server &quot;0.5.0&quot;]
                 [reagent &quot;0.8.1&quot;]
                 [reagent-utils &quot;0.3.1&quot;]
                 [ring &quot;1.6.3&quot;]
                 [ring/ring-defaults &quot;0.3.1&quot;]
                 [compojure &quot;1.6.1&quot;]
                 [hiccup &quot;1.0.5&quot;]
                 [yogthos/config &quot;1.1.1&quot;]
                 [org.clojure/clojurescript &quot;1.10.339&quot;
                  :scope &quot;provided&quot;]
                 [secretary &quot;1.2.3&quot;]
                 [venantius/accountant &quot;0.2.4&quot;
                  :exclusions [org.clojure/tools.reader]]
                 [phrase &quot;0.3-alpha4&quot;]]
</code></pre>
<div class="alert alert-warning"><p>Don't forget to restart Figwheel as project changes aren't auto applied the same way that source changes are.</p>
</div>
<p>Next you have to add the namespace in <code>core.cljs</code>.</p>
<pre><code class="language-Clojure">(ns validation-experiment.core
  (:require [reagent.core :as reagent :refer [atom]]
            [validation-experiment.ssn :as ssn]
            [clojure.spec.alpha :as s]
            [phrase.alpha :refer [phrase-first defphraser]]))
</code></pre>
<p>With that out of the way, we can modify our component to use <code>phrase-first</code> and produce a more meaningful validation message.</p>
<pre><code class="language-Clojure">(defphraser :default
  [_ _]
  &quot;Invalid value!&quot;)

(defn example []
  [:div [:label &quot;Enter SSN: &quot; [:input {:type :text :value &#64;ssn :on-change #(reset! ssn (-&gt; % .-target .-value))}]]
   [:p {:style {:color &quot;red&quot;}} (phrase-first {} :validation-experiment.ssn/ssn &#64;ssn)]])
</code></pre>
<p>The call to <code>defphraser</code> registered a default message to display any time there's a validation error. Try it out. No more &ldquo;meaningless&rdquo; Clojure Spec data, and instead you see &quot;Invalid value!&quot; when validation fails.</p>
<h2 id="bringing-detail-back">Bringing Detail Back</h2>
<p>That's great and all, but we've lost information about <em>why</em> the validation failed! Let's fix that. Since the &ldquo;why&rdquo; is specific to our Clojure Spec definitions, let's keep the code in the same namespace. So, modify the <code>ssn.cljc</code> file's namespace to include Phrase.</p>
<pre><code class="language-Clojure">(ns validation-experiment.ssn
  (:require [clojure.spec.alpha :as s]
            [clojure.string :as string]
            [phrase.alpha :refer [defphraser]]))
</code></pre>
<p>Now at the end of that file define messages for each of our predicates.</p>
<pre><code class="language-Clojure">(defphraser valid-format?
  [_ _]
  &quot;Not a valid SSN format.&quot;)

(defphraser valid-area?
  [_ _]
  &quot;Not a valid area segment.&quot;)

(defphraser valid-group?
  [_ _]
  &quot;Not a valid group segment.&quot;)

(defphraser valid-serial-number?
  [_ _]
  &quot;Not a valid serial number.&quot;)
</code></pre>
<p>Much better! We could do a little better yet, though. Not everyone knows what the &ldquo;area&rdquo;, &quot;group&quot; and &ldquo;serial number&rdquo; segments are. Let's make this a little clearer by displaying the invalid portion of the input in the message.</p>
<pre><code class="language-Clojure">(defphraser valid-area?
  [_ {:keys [val]}]
  (str &quot;\&quot;&quot; (subs val 0 3) &quot;\&quot; is not a valid area segment.&quot;))

(defphraser valid-group?
  [_ {:keys [val]}]
  (str &quot;\&quot;&quot; (subs (digits val) 3 5) &quot;\&quot; is not a valid group segment.&quot;))

(defphraser valid-serial-number?
  [_ {:keys [val]}]
  (str &quot;\&quot;&quot; (subs (digits val) 5 9) &quot;\&quot; is not a valid serial number.&quot;))
</code></pre>
<p>Yet again, it was really easy to go from a validation message only a Clojurist would love, to rich and human readable messages.</p>
<p><a href="/posts/clojure-validation-part-4">Next time</a> we'll cover a bonus topic&hellip; localizing these messages.</p>
<div class="alert alert-success"><p>The code for this part of the series can be found in the branch <code>part3</code> in the associated repo at <a href="https://github.com/wekempf/validation-experiment">https://github.com/wekempf/validation-experiment</a>.</p>
</div>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'digitaltapestry'; // required: replace example with your forum shortname
    var disqus_identifier = 'clojure-validation-part-3';
    var disqus_title = 'Clojure Validation - Part III';
    var disqus_url = 'https://digitaltapestry.net/posts/clojure-validation-part-3';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-inline text-center">
                <li>
                    <a href="https://twitter.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
            </ul>
            <p class="copyright text-muted">
                Copyright © 2020 by William E. Kempf. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way.
                <br />
                This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                <br />
                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                <br />
                <a href="https://github.com/wekempf/wekempf.github.io"><i class="fa fa-github"></i> This Site on GitHub</a>
                <br />
                Hosted on <a href="https://pages.github.com/">GitHub Pages</a>
                <br />
                <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
            </p>
        </div>
    </div>
</div>
                </footer> 

                <script src="/assets/js/jquery.min.js"></script>
                <script src="/assets/js/bootstrap.min.js"></script>     
                <script src="/assets/js/highlight.pack.js"></script>   
                <script src="/assets/js/clean-blog.js"></script>
                <script src="/assets/js/d3.v3.min.js"></script>
                <script src="/assets/js/trianglify.min.js"></script>
                <script src="/assets/js/Please-compressed.js"></script>
                <script src="/assets/js/background-check.min.js"></script>

                <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
                <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
                <!--[if lt IE 9]>
                        <script src="/assets/js/html5shiv.js"></script>
                        <script src="/assets/js/respond.min.js"></script>
                <![endif]-->
                
                <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
<script>mermaid.initialize({startOnLoad:true});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.16/clipboard.min.js"></script>
<script type="text/javascript">
    anchors.options.placement = 'left';
    anchors.add('#content > h1,h2,h3,h4');

    var snippets = document.querySelectorAll("pre > code");
    [].forEach.call(snippets, function(snippet) {
        snippet.insertAdjacentHTML("beforebegin", "<button class='btn-copy' data-clipboard-snippet><img class='clippy' width=13 src='/assets/images/clippy.svg' alt='Copy to clipboard'></button>");
    });
    var clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
        target: function(trigger) {
            return trigger.nextElementSibling;
        }
    });
    clipboardSnippets.on('success', function(e) {
        e.clearSelection();
        showTooltip(e.trigger, "Copied!");
    });
    clipboardSnippets.on('error', function(e) {
        showTooltip(e.trigger, fallbackMessage(e.action));
    });

    var btns = document.querySelectorAll('.btn-copy');
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener('mouseleave', function(e) {
            e.currentTarget.setAttribute('class', 'btn-copy');
            e.currentTarget.removeAttribute('aria-label');
        });
    }

    function showTooltip(elem, msg) {
        elem.setAttribute('class', 'btn-copy tooltipped tooltipped-s');
        elem.setAttribute('aria-label', msg);
    }

    function fallbackMessage(action) {
        var actionMsg = '';
        var actionKey = (action === 'cut' ? 'X' : 'C');
        if (/iPhone|iPad/i.test(navigator.userAgent)) {
            actionMsg = 'No support :(';
        } else if (/Mac/i.test(navigator.userAgent)) {
            actionMsg = 'Press ⌘-' + actionKey + ' to ' + action;
        } else {
            actionMsg = 'Press Ctrl-' + actionKey + ' to ' + action;
        }
        return actionMsg;
    }
    hljs.initHighlightingOnLoad();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70929529-2', 'auto');
  ga('send', 'pageview');
</script>
<script type="text/javascript" src="/assets/scripts/clojure-validation-part-3/app.js"></script>

                <script>hljs.initHighlightingOnLoad();</script>


                <script>
                        BackgroundCheck.init({
                                targets: '.intro-header,.navbar',
                                images: '.intro-header'
                        });
                </script>
        </body>
</html>



<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Digital Tapestry - Understanding Task - Part II</title>
        <meta name="description" content="Weaving a Digital Tapestry" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Digital Tapestry" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Digital Tapestry" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico?v=2" type="image/x-icon">
        <link rel="icon" href="/favicon.ico?v=2" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />
        <ling href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css" rel="stylesheet" type="text/css">


        <meta name="application-name" content="Digital Tapestry" />
        <meta name="msapplication-tooltip" content="Digital Tapestry" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Digital Tapestry - Understanding Task - Part II" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://digitaltapestry.net/posts/understanding-task-II" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
        <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

                <style>
                        .intro-header *, .navbar:not(.is-fixed) * { color: GoldenRod !important; }
                        hr { border-color: GoldenRod !important; }
                        .btn { color: initial !important }
                </style>

        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Digital Tapestry</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/tags">All Tags</a></li>
        <li><a href="/posts">Archive</a></li>
        <li><a href="/resume">Resume</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/banner_web.jpg&quot;)">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Understanding Task - Part II</h1>
    <div class="meta">        
Published on Saturday, January 7, 2017<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/net" class="btn btn-default btn-xs">.NET</a>
                    <a role="button" href="/tags/c%23" class="btn btn-default btn-xs">C#</a>
                    <a role="button" href="/tags/task" class="btn btn-default btn-xs">Task</a>
                    <a role="button" href="/tags/tpl" class="btn btn-default btn-xs">TPL</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<h1 id="understanding-task">Understanding Task</h1>
<h2 id="part-i">Part I</h2>
<p>In <a href="/posts/understanding-task-I">Part I</a> I explained that a <code>Task</code> is really <strong>just</strong> a datastructure
that represents the result of &ldquo;something&rdquo;, and implemented a <em>very</em> basic <code>MyTask&lt;T&gt;</code> to illustrate
that. Of course, that isn't a very complete picture and I promised that this time around we'd
update <code>MyTask&lt;T&gt;</code> to more closely represent the mental model you have for <code>Task</code>.</p>
<p>Most developer's mental model is very firmly fixed around a <code>Task</code> representing a thread, or maybe
they have a slightly better understanding and think of it as something run on the thread pool. A
very few might actually think in terms of any asynchronous operation, which is much closer to the
truth. In the Task Programming Library (TPL) we call it a <code>Task</code>, but other languages and frameworks
call them a <code>Promise</code> or a <code>Future</code>. These are probably better names, to be honest, as they get you
closer to the correct mental model.</p>
<p>I said a <code>Task</code> is just the result of <em>something</em>, but let's refine that. It's a datastructure that
represents the result of <em>something once there is a result</em>. The result may exist now, or it may
exist in the future, and the <code>Task</code> represents that result <em>now</em>. That may be a complicated explanation
for you to understand, so once again we'll attempt to make it concrete.</p>
<p>Currently, our <code>MyTask&lt;T&gt;</code> represents a result that's already available. Let's modify it so it can
<em>also</em> represent a result that may be available only in the future. Here's our code so far.</p>
<pre><code class="language-csharp">public class MyTask&lt;TResult&gt;
{
    private MyTask()
    {
    }

    public static MyTask&lt;TResult&gt; SetError(Exception e) =&gt; new MyTask&lt;TResult&gt; { Error = e };

    public static MyTask&lt;TResult&gt; SetResult(TResult result) =&gt; new MyTask&lt;TResult&gt; { Result = result };

    public Exception Error { get; private set; }

    public TResult Result { get; private set; }
}
</code></pre>
<p>If this is  going to represent a result that may only be available in the future, we need some way to
set the result in the future. This is a tricky thing to solve, and this is where the TPL gets really
clever. We need to create a <code>MyTask&lt;T&gt;</code> that doesn't have a result, and then have some way to set the
result in the future. However, we don't want just anyone to be able to set the result. We want only
the code/method that creates the <code>MyTask&lt;T&gt;</code> instance to be able to set its result. The TPL does this
by using another type as both a factory object and the only way to set the result of the <code>Task</code>.
In the TPL, this type is called the <code>TaskCompletionSource&lt;T&gt;</code>. Let's create our own <code>MyTaskCompletionSource&lt;T&gt;</code>.</p>
<pre><code class="language-csharp">public class MyTask&lt;TResult&gt;
{
    internal MyTask()
    {
    }

    public Exception Error { get; internal set; }

    public TResult Result { get; internal set; }
}

public class MyTaskCompletionSource&lt;TResult&gt;
{
    public MyTask&lt;TResult&gt; Task { get; } = new MyTask&lt;TResult&gt;();

    public void SetError(Exception e) =&gt; Task.Error = e;

    public void SetResult(TResult result) =&gt; Task.Result = result;
}
</code></pre>
<p>The <code>MyTask&lt;T&gt;</code> constructor and the setters for <code>Error</code> and <code>Result</code> are all declared internal. Only
<code>MyTaskCompletionSource&lt;T&gt;</code> should call these. The only way for end user code to create a <code>MyTask&lt;T&gt;</code>
and to set its results is to use a <code>MyTaskCompletionSource&lt;T&gt;</code>.</p>
<p>So, we've split up the construction from the setting of the results, allowing us to set the results sometime
in the future. However, there's no way to know when the result is available, and so trying to get the
<code>Result</code> or the <code>Error</code> before it's been set won't behave the way we'd like. Things will get a bit more
complicated now, but lets solve these problems.</p>
<pre><code class="language-csharp">public class MyTask&lt;TResult&gt;
{
    private readonly ManualResetEvent completedEvent = new ManualResetEvent(false);
    private Exception error;
    private TResult result;

    internal MyTask()
    {
    }

    public Exception Error
    {
        get
        {
            this.completedEvent.WaitOne();
            return this.error;
        }

        set
        {
            this.error = value;
            this.completedEvent.Set();
        }
    }

    public TResult Result
    {
        get
        {
            this.completedEvent.WaitOne();
            if (this.error != null)
            {
                throw new InvalidOperationException(&quot;Operation failed.&quot;, this.error);
            }

            return this.result;
        }

        set
        {
            this.result = value;
            this.completedEvent.WaitOne();
        }
    }
}

public class MyTaskCompletionSource&lt;TResult&gt;
{
    public MyTask&lt;TResult&gt; Task { get; } = new MyTask&lt;TResult&gt;();

    public void SetError(Exception e) =&gt; Task.Error = e;

    public void SetResult(TResult result) =&gt; Task.Result = result;
}
</code></pre>
<blockquote class="blockquote">
<p>WARNING: The above code is <strong>NOT</strong> thread-safe.</p>
</blockquote>
<p>I told you I'd show you a naive implementation. This code illustrates the ideas well, but it is <strong>NOT</strong>
thread-safe and there are other issues (like the <code>MyTaskCompletionSource&lt;T&gt;</code> being able to set
both a <code>Result</code> and an <code>Error</code>). I'm not trying to write production code here, but instead to just
get across the concepts. Since <code>Task</code> already exists I feel safe in posting code like this, because no
one would ever use it, but heed my warning: don't use this code as a way to understand how to write
thread-safe or production code.</p>
<p>So, with the warnings out of the way, let's see what we did. Our <code>MyTask&lt;T&gt;</code> now has a <code>ManualResetEvent</code>
that helps us to know <em>when</em> the results have been set. We modified the setters for <code>Error</code> and
<code>Result</code> so that when the <code>MyTaskCompletionSource&lt;T&gt;</code> calls them the event is set as well. Meanwhile,
the getters wait for this event to be set, making them blocking calls that will wait for the values
to be set before returning them. In addition, I went ahead and made the getter for <code>Result</code> throw an
exception if the result is actually an <code>Error</code> instead.</p>
<p>I hope the lightbulb just turned on for many of you. While the implementation is horrid, it does
represent the bulk of what a real <code>Task</code> is. In fact, there's only two concepts we've left out
here: continuations and cancellation. I'm not going to cover those anytime soon.</p>
<p>Note that there's no <code>Thread</code> anywhere in this code. Nor have I used the thread pool. Despite that,
this <em>is</em> a complete representation of a <code>Task</code> (minus continuations and cancellation, of course).
I here some of you saying &ldquo;but what about <code>Task.Run</code>?&rdquo; Well, we'll talk about that and other
related concepts next time, but <code>Task</code> doesn't really need them. This is really the complete
concept of a <code>Task</code>, and if you shift your mental model to think in these terms you'll be
much better suited for using the TPL.</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'digitaltapestry'; // required: replace example with your forum shortname
    var disqus_identifier = 'understanding-task-II';
    var disqus_title = 'Understanding Task - Part II';
    var disqus_url = 'http://digitaltapestry.net/posts/understanding-task-II';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-inline text-center">
                <li>
                    <a href="https://twitter.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
            </ul>
            <p class="copyright text-muted">
                Copyright © 2017 by William E. Kempf. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way.
                <br />
                This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                <br />
                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                <br />
                <a href="https://github.com/wekempf/wekempf.github.io"><i class="fa fa-github"></i> This Site on GitHub</a>
                <br />
                Hosted on <a href="https://pages.github.com/">GitHub Pages</a>
                <br />
                <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
            </p>
        </div>
    </div>
</div>
                </footer> 

                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.16/clipboard.min.js"></script>
<script type="text/javascript">
    anchors.options.placement = 'left';
    anchors.add('#content > h1,h2,h3,h4');

    var snippets = document.querySelectorAll("pre > code");
    [].forEach.call(snippets, function(snippet) {
        snippet.insertAdjacentHTML("beforebegin", "<button class='btn-copy' data-clipboard-snippet><img class='clippy' width=13 src='/assets/images/clippy.svg' alt='Copy to clipboard'></button>");
    });
    var clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
        target: function(trigger) {
            return trigger.nextElementSibling;
        }
    });
    clipboardSnippets.on('success', function(e) {
        e.clearSelection();
        showTooltip(e.trigger, "Copied!");
    });
    clipboardSnippets.on('error', function(e) {
        showTooltip(e.trigger, fallbackMessage(e.action));
    });

    var btns = document.querySelectorAll('.btn-copy');
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener('mouseleave', function(e) {
            e.currentTarget.setAttribute('class', 'btn-copy');
            e.currentTarget.removeAttribute('aria-label');
        });
    }

    function showTooltip(elem, msg) {
        elem.setAttribute('class', 'btn-copy tooltipped tooltipped-s');
        elem.setAttribute('aria-label', msg);
    }

    function fallbackMessage(action) {
        var actionMsg = '';
        var actionKey = (action === 'cut' ? 'X' : 'C');
        if (/iPhone|iPad/i.test(navigator.userAgent)) {
            actionMsg = 'No support :(';
        } else if (/Mac/i.test(navigator.userAgent)) {
            actionMsg = 'Press ⌘-' + actionKey + ' to ' + action;
        } else {
            actionMsg = 'Press Ctrl-' + actionKey + ' to ' + action;
        }
        return actionMsg;
    }
    hljs.initHighlightingOnLoad();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70929529-2', 'auto');
  ga('send', 'pageview');
</script>
                <script>hljs.initHighlightingOnLoad();</script>

        </body>
</html>


<!DOCTYPE html>
<html lang="en">
        <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge"/>

        <title>Digital Tapestry - Playing With Equality</title>
        <meta name="description" content="Weaving a Digital Tapestry" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">        

        <link type="application/rss+xml" rel="alternate" title="Digital Tapestry" href="/feed.rss" />
        <link type="application/atom+xml" rel="alternate" title="Digital Tapestry" href="/feed.atom" />
        <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
        <link rel="icon" href="/favicon.ico" type="image/x-icon">

        <link href="/assets/css/bootstrap.min.css" rel="stylesheet" />
        <link href="/assets/css/highlight.css" rel="stylesheet">
        <link href="/assets/css/clean-blog.css" rel="stylesheet" />
        <link href="/assets/css/master.css" rel="stylesheet" />
        <link href="/assets/css/font-awesome.min.css" rel="stylesheet" type="text/css">
        <link href='//fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css'>
        <link href="/assets/css/override.css" rel="stylesheet" />
        <ling href="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.css" rel="stylesheet" type="text/css">


        <meta name="application-name" content="Digital Tapestry" />
        <meta name="msapplication-tooltip" content="Digital Tapestry" />
        <meta name="msapplication-starturl" content="/" />

        <meta property="og:title" content="Digital Tapestry - Playing With Equality" />
        <meta property="og:type" content="website" />
        <meta property="og:url" content="http://digitaltapestry.net/posts/playing-with-equality" />
        <!-- TODO: More social graph meta tags -->

        <script src="/assets/js/jquery.min.js"></script>
        <script src="/assets/js/bootstrap.min.js"></script>     
        <script src="/assets/js/highlight.pack.js"></script>   
        <script src="/assets/js/clean-blog.js"></script>
        <script src="/assets/js/d3.v3.min.js"></script>
        <script src="/assets/js/trianglify.min.js"></script>
        <script src="/assets/js/Please-compressed.js"></script>
        <script src="https://cdn.rawgit.com/knsv/mermaid/6.0.0/dist/mermaid.min.js"></script>
        <script>mermaid.initialize({startOnLoad:true});</script>
                
        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
                <script src="/assets/js/html5shiv.js"></script>
                <script src="/assets/js/respond.min.js"></script>
        <![endif]-->

                <style>
                        .intro-header *, .navbar:not(.is-fixed) * { color: GoldenRod !important; }
                        hr { border-color: GoldenRod !important; }
                        .btn { color: initial !important }
                </style>

        </head>
        <body>
                
                <!-- Navigation -->
                <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
                        <div class="container-fluid">
                                <!-- Brand and toggle get grouped for better mobile display -->
                                <div class="navbar-header page-scroll">
                                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar-collapse">
                                        <span class="sr-only">Toggle navigation</span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        <span class="icon-bar"></span>
                                        </button>
                                        <a class="navbar-brand" href="/">Digital Tapestry</a>
                                </div>
                        
                                <!-- Collect the nav links, forms, and other content for toggling -->
                                <div class="collapse navbar-collapse" id="navbar-collapse">
                                        <ul class="nav navbar-nav navbar-right">
                                                        <li><a href="/tags">All Tags</a></li>
        <li><a href="/posts">Archive</a></li>
        <li><a href="/resume">Resume</a></li>
 
                                        </ul>
                                </div>
                                <!-- /.navbar-collapse -->
                        </div>
                        <!-- /.container -->
                </nav>
                
                <!-- Page Header -->
                <header class="intro-header" id="intro-header" style="background-image: url(&quot;/assets/images/banner_web.jpg&quot;)">
                        <div class="container">
                                <div class="row">
                                        <div class="col-md-12">

    
<div class="post-heading">
    <h1>Playing With Equality</h1>
    <div class="meta">        
Published on Saturday, January 14, 2017<br>    </div>
        <div class="tags">
                    <a role="button" href="/tags/net" class="btn btn-default btn-xs">.NET</a>
                    <a role="button" href="/tags/c%23" class="btn btn-default btn-xs">C#</a>
        </div>     
</div>
                                        </div>
                                </div>
                        </div>
                </header>
                
                <!-- Main Content -->
                <div class="container">
                        <div class="row">
                                <div id="content" class="col-md-12">
                                        

<h1 id="playing-with-equality">Playing With Equality</h1>
<p>Most developers think they understand equality, but it's actually a pretty tricky subject.
Implementing equality correctly is much more complicated than most realize. In this post
I'm going to play around with equality, showing you some things you may not be aware of,
and eventually show you an interesting trick you can use when implementing equality.</p>
<h2 id="value-equality">Value Equality</h2>
<p>Did you know that in .NET you get value equality for free? Value types automatically
implement <code>object.Equals</code> and <code>object.GetHashCode</code> to &ldquo;do the right thing&rdquo;.
Here's a simple <code>Point</code> struct.</p>
<pre><code class="language-csharp">public struct Point
{
    public int X { get; set; }

    public int Y { get; set; }
}
</code></pre>
<p>And here's some simple code to illustrate the equality behavior you get for free.</p>
<pre><code class="language-csharp">var p1 = new Point { X = 10, Y = 20 };
var p2 = new Point { X = 10, Y = 30 };
var p3 = new Point { X = 10, Y = 20 };

WriteLine(p1.Equals(p1));
WriteLine(p1.Equals(p2));
WriteLine(p1.Equals(p3));
WriteLine(p1.GetHashCode());
WriteLine(p2.GetHashCode());
WriteLine(p3.GetHashCode());
</code></pre>
<p>This produces the following results.</p>
<pre><code class="language-text">True
False
True
346948930
346948936
346948930
</code></pre>
<p>So <code>object.Equals</code> behaves as you'd expect, as does <code>object.GetHashCode</code>. What you
don't get is <code>IEquatable&lt;Point&gt;</code>, unfortunately, but for value types that's fairly
easy to implement.</p>
<pre><code class="language-csharp">public struct Point : IEquatable&lt;Point&gt;
{
    public int X { get; set; }

    public int Y { get; set; }

        public bool Equals(Point other) =&gt; object.Equals(this, other);
}
</code></pre>
<h2 id="reference-equality">Reference Equality</h2>
<p>It's not so simple for reference types. Reference types don't provide value equality,
they provide reference equality. Let's illustrate.</p>
<pre><code class="language-csharp">public class RefPoint
{
    public int X { get; set; }

    public int Y { get; set; }
}
</code></pre>
<p>This is identical to our original <code>Point</code>, except it's a class instead of a struct.
Let's use it like we did the struct.</p>
<pre><code class="language-csharp">var p4 = new RefPoint { X = 10, Y = 20 };
var p5 = new RefPoint { X = 10, Y = 30 };
var p6 = new RefPoint { X = 10, Y = 20 };

WriteLine(p4.Equals(p4));
WriteLine(p4.Equals(p5));
WriteLine(p4.Equals(p6));
WriteLine(p4.GetHashCode());
WriteLine(p5.GetHashCode());
WriteLine(p6.GetHashCode());
</code></pre>
<p>Here's the result.</p>
<pre><code class="language-text">True
False
False
21083178
55530882
30015890
</code></pre>
<p>So, every instance has it's own unique hash code and an instance is only equal to itself.
This is reference equality. We can override the behavior to get back value equality, but
it's non-trivial.</p>
<pre><code class="language-csharp">public class RefPoint : IEquatable&lt;RefPoint&gt;
{
    public int X { get; set; }

    public int Y { get; set; }

    public override bool Equals(object obj) =&gt; this.Equals(obj as RefPoint);

    public override int GetHashCode() =&gt;
        (this.X.GetHashCode() * 486187739) + this.Y.GetHashCode();

    public bool Equals(RefPoint other) =&gt;
        other == null
            ? false
            : this.X == other.X &amp;&amp; this.Y == other.Y;
}
</code></pre>
<p>Handling <code>null</code> is a bit tricky, but most of us should be able to handle that corectly if
we're careful. <code>GetHashCode</code> is another matter. Not many people know how to implement a good
hashing algorithm. With some web searching you can come across the basic algorithm I've used
here: you multiply each &ldquo;part&rdquo; (each field/property) except the last by some large prime
number and add all of the results together. You could memorize this, but it's still a lot
of fiddly code to have to write for such an &quot;easy&quot; concept as equality.</p>
<h2 id="valuetuple-trick">ValueTuple trick</h2>
<p>I promised a trick. Well, we know that value types implement equality by default. There's
a trick you can take advantage of when implementing equality for reference types.</p>
<p>In C# 7 they've introduced tuples into the language. Under the cover these tuples are
instances of a new type: <code>ValueTuple</code>. This type is, as it's name implies, a value type.
Since value types implement <code>object.Equals</code> and <code>object.GetHashCode</code>, we can take
advantage of that when implementing them for reference types.</p>
<pre><code class="language-csharp">public class RefPoint : IEquatable&lt;RefPoint&gt;
{
    public int X { get; set; }

    public int Y { get; set; }

    public override bool Equals(object obj) =&gt; this.Equals(obj as RefPoint);

    public override int GetHashCode() =&gt;
        this.AsTuple().GetHashCode();

    public bool Equals(RefPoint other) =&gt;
        other == null
            ? false
            : this.AsTuple().Equals(other.AsTuple());

    private (int X, int Y) AsTuple() =&gt; (this.X, this.Y);
}
</code></pre>
<p>We stil have to handle <code>null</code>, unfortunately, but the rest has become much easier.
BTW, in older versions of C# you can do the same thing with an anonymous type
or a custom value type, but neither is as nice as the <code>ValueTuple</code>.</p>
<h2 id="wishful-thinking">Wishful Thinking</h2>
<p>The Ruby language has this nice little concept of the &ldquo;spaceship operator&rdquo;. The
<code>&lt;=&gt;</code> operator is basically equivelent to <code>IComparable.Compare</code>, returning a
negative value if the left value is less than the right value, a positive value
if the left value is greater than the right value and zero if the left value is
equal to the right value. The real beauty here is if you define this one operator,
everything else is defined for you. Wouldn't it be awesome if we had the same
concept in C#? In C# we split <code>IEquatable</code> and <code>IComparable</code> concepts up, rightfully,
so we might need two operators. I'll call them <code>===</code> and <code>&lt;=&gt;</code>. If you defined
<code>&lt;=&gt;</code> you'd get <code>IEqutable</code>, <code>IComparable</code>, <code>object.Equals</code>, <code>object.GetHashCode</code>,
<code>==</code>, <code>!=</code>, <code>&lt;</code>, <code>&lt;=</code>, <code>&gt;</code> and <code>&gt;=</code> all implemented for you by the compiler.
If you implemented <code>===</code> instead you'd get <code>IEquatable</code>, <code>object.Equals</code>,
<code>object.GetHashCode</code>, <code>==</code> and <code>!=</code>. Oh, and as long as we're wishing,
let's make it really simple to implement these two operators.</p>
<pre><code class="language-csharp">public class RefPoint
{
    public int X { get; set; }

    public int Y { get; set; }

    public operator ===() =&gt; this.X, this.Y;
}
</code></pre>
<p>In the above example we implemented this hypothetical operator not by declaring
how to compare but by only declaring what to compare. This allows the definition
to automatically implement everything else for us, basically giving us code equivalent
to what I showed for the <code>ValueTuple</code> trick (plus the operators).</p>
<p>Yeah, I'm not entirely sold on the syntax here either. After all, there's no <code>===</code> or
<code>&lt;=&gt;</code> operators you can use anywhere other than in declaring things here. Maybe it would
make more sense with syntax like this.</p>
<pre><code class="language-csharp">public class RefPoint
    equatable : X, Y
{
    public int X { get; set; }

    public int Y { get; set; }
}
</code></pre>
<p>Still, the idea of no longer having to deal with the intricacies of implementing equality
(or ordering) by hand, the source of far too many bugs, is enticing, isn't it?</p>


<div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'digitaltapestry'; // required: replace example with your forum shortname
    var disqus_identifier = 'playing-with-equality';
    var disqus_title = 'Playing With Equality';
    var disqus_url = 'http://digitaltapestry.net/posts/playing-with-equality';

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
    
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = '//' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                                </div>
                        </div>
                </div>
                
                <hr>
                
                <!-- Footer -->
                <footer>
                        <div class="container">
    <div class="row">
        <div class="col-md-12">
            <ul class="list-inline text-center">
                <li>
                    <a href="https://twitter.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
                <li>
                    <a href="https://github.com/wekempf">
                        <span class="fa-stack fa-lg">
                            <i class="fa fa-circle fa-stack-2x"></i>
                            <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                        </span>
                    </a>
                </li>
            </ul>
            <p class="copyright text-muted">
                Copyright © 2017 by William E. Kempf. The opinions expressed herein are my own and do not represent those of my employer or any other third-party views in any way.
                <br />
                This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/" rel="license">Creative Commons Attribution 4.0 International License</a>.
                <br />
                <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a> | <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                <br />
                <a href="https://github.com/wekempf/wekempf.github.io"><i class="fa fa-github"></i> This Site on GitHub</a>
                <br />
                Hosted on <a href="https://pages.github.com/">GitHub Pages</a>
                <br />
                <strong><a href="https://wyam.io">Generated by Wyam</a></strong>
            </p>
        </div>
    </div>
</div>
                </footer> 

                <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.2.2/anchor.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.5.16/clipboard.min.js"></script>
<script type="text/javascript">
    anchors.options.placement = 'left';
    anchors.add('#content > h1,h2,h3,h4');

    var snippets = document.querySelectorAll("pre > code");
    [].forEach.call(snippets, function(snippet) {
        snippet.insertAdjacentHTML("beforebegin", "<button class='btn-copy' data-clipboard-snippet><img class='clippy' width=13 src='/assets/images/clippy.svg' alt='Copy to clipboard'></button>");
    });
    var clipboardSnippets = new Clipboard('[data-clipboard-snippet]', {
        target: function(trigger) {
            return trigger.nextElementSibling;
        }
    });
    clipboardSnippets.on('success', function(e) {
        e.clearSelection();
        showTooltip(e.trigger, "Copied!");
    });
    clipboardSnippets.on('error', function(e) {
        showTooltip(e.trigger, fallbackMessage(e.action));
    });

    var btns = document.querySelectorAll('.btn-copy');
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener('mouseleave', function(e) {
            e.currentTarget.setAttribute('class', 'btn-copy');
            e.currentTarget.removeAttribute('aria-label');
        });
    }

    function showTooltip(elem, msg) {
        elem.setAttribute('class', 'btn-copy tooltipped tooltipped-s');
        elem.setAttribute('aria-label', msg);
    }

    function fallbackMessage(action) {
        var actionMsg = '';
        var actionKey = (action === 'cut' ? 'X' : 'C');
        if (/iPhone|iPad/i.test(navigator.userAgent)) {
            actionMsg = 'No support :(';
        } else if (/Mac/i.test(navigator.userAgent)) {
            actionMsg = 'Press ⌘-' + actionKey + ' to ' + action;
        } else {
            actionMsg = 'Press Ctrl-' + actionKey + ' to ' + action;
        }
        return actionMsg;
    }
    hljs.initHighlightingOnLoad();
</script>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-70929529-2', 'auto');
  ga('send', 'pageview');
</script>
                <script>hljs.initHighlightingOnLoad();</script>

        </body>
</html>
